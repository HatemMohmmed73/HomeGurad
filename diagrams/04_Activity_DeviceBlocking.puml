@startuml Activity Diagram - Device Blocking Workflow
!theme plain
skinparam activity {
  BackgroundColor #E8F5E9
  BorderColor #4CAF50
  FontColor #000
}

start

:Administrator views device list
or device details page;

:Administrator identifies suspicious device;

:Administrator clicks "Block Device" button;

:Frontend sends POST /api/devices/{id}/block
with JWT token;

:Backend receives request;

:Backend validates JWT token;

if (Token valid?) then (No)
  :Return 401 Unauthorized;
  stop
else (Yes)
endif

:Backend checks user role;

if (User is admin?) then (No)
  :Return 403 Forbidden;
  stop
else (Yes)
endif

:Backend queries database/file
for device by ID/IP/MAC;

if (Device found?) then (No)
  :Return 404 Not Found;
  stop
else (Yes)
endif

partition "Firewall Enforcement" {
  :Backend calls FirewallController.block_device()
  with device IP and MAC;
  
  :FirewallController creates nftables rule:
  nft add rule inet homeguard blocked_devices
  ip saddr {IP} drop;
  
  :FirewallController creates MAC rule:
  nft add rule inet homeguard blocked_devices
  ether saddr {MAC} drop;
  
  if (Firewall rule created?) then (No)
    :Return 500 Internal Server Error;
    stop
  else (Yes)
  endif
  
  :FirewallController stores blocked device
  in memory (for tracking);
}

partition "Database Update" {
  :Backend updates device status
  to "BLOCKED" in database/file;
  
  :Backend sets is_blocked = true;
  
  :Backend updates last_seen timestamp;
}

partition "Real-time Notification" {
  :Backend formats device update
  for WebSocket;
  
  :Backend sends to WebSocket Manager;
  
  :WebSocket Manager broadcasts to
  all connected clients in /ws/devices;
  
  :Frontend receives device update;
  
  :Frontend updates device status
  in dashboard (without refresh);
}

:Backend returns success response:
- Message: "Device blocked successfully"
- Device ID
- Status: BLOCKED;

:Frontend displays success message;

:Administrator sees device status
changed to "Blocked" (red indicator);

stop

@enduml

