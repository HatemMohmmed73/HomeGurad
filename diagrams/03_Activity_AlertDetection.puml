@startuml Activity Diagram - Alert Detection and Notification Flow
!theme plain
skinparam activity {
  BackgroundColor #FFF3E0
  BorderColor #FF9800
  FontColor #000
}

start

:Orange Pi monitoring scripts
detect anomaly in device traffic;

:Orange Pi writes new alert
to alerts.json file;

:Alert Monitor service detects
file modification (every 2 seconds);

:Alert Monitor reads alerts.json;

:Alert Monitor compares current
alert IDs with tracked IDs;

if (New alerts found?) then (No)
  :Continue monitoring;
  stop
else (Yes)
endif

:Alert Monitor extracts alert data:
- Device IP/MAC
- Severity
- Anomaly score
- Reason
- Timestamp;

partition "WebSocket Notification" {
  :Alert Monitor formats alert
  for WebSocket;
  
  :Send alert to WebSocket Manager;
  
  :WebSocket Manager broadcasts
  to all connected clients
  in /ws/alerts channel;
  
  if (Clients connected?) then (Yes)
    :Frontend receives WebSocket message;
    :Display alert popup;
    :Show browser notification;
    :Update alerts list;
    :Show toast notification;
  else (No)
    :No WebSocket delivery;
  endif
}

partition "Push Notification" {
  :Alert Monitor formats alert
  for push notification;
  
  :Send to Push Notification Service;
  
  :Push Service retrieves all
  active subscriptions from MongoDB;
  
  if (Subscriptions exist?) then (Yes)
    :Push Service sends notification
    to each subscription;
    
    if (Notification sent successfully?) then (Yes)
      :Update subscription last_used;
    else (No)
      :Mark subscription as inactive;
    endif
  else (No)
    :No push delivery;
  endif
}

:Alert Monitor updates tracked
alert IDs;

:Continue monitoring for new alerts;

stop

@enduml

